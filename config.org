#+EXPORT_FILE_NAME: README
* Preamble
This is my private DOOM emacs configuration. It is tangled by the ~config.org~
and exported to markdown to produce this README.

Username and e-mail:
#+BEGIN_SRC emacs-lisp
(setq user-full-name "Luca Cambiaghi"
      user-mail-address "luca.cambiaghi@me.com")
#+END_SRC

Scratch buffer major mode:
#+BEGIN_SRC emacs-lisp
(setq doom-scratch-buffer-major-mode 'emacs-lisp-mode)
#+END_SRC

* Keybindings
Let's have ~general~ auto-unbind keys:
#+BEGIN_SRC emacs-lisp
(general-auto-unbind-keys)
#+END_SRC

We then remap some of the bindings (inspired by [[https://github.com/jsmestad/dfiles/blob/master/.doom.d/%2Bbindings.el#L496-L854][bindings.el]]).
#+BEGIN_SRC emacs-lisp
(map! :leader
      :desc "M-x"                   :n "SPC" #'counsel-M-x
      :desc "Async shell command"   :n "!"   #'async-shell-command
      :desc "Toggle eshell"         :n "'"   #'+eshell/toggle

      (:desc "windows" :prefix "w"
        :desc "Cycle focus to other window(s)" :n "TAB" #'other-window )

      (:desc "open" :prefix "o"
        :desc "Terminal"              :n  "t" #'+term/toggle
        :desc "Eshell"                :n  "e" #'+eshell/toggle )
      (:desc "project" :prefix "p"
        :desc "Eshell"               :n "'" #'projectile-run-eshell )
)
#+END_SRC
* User Interface
** Turn off line numbers
#+BEGIN_SRC emacs-lisp
(setq display-line-numbers-type nil)
#+END_SRC
** Font and font size:
#+BEGIN_SRC emacs-lisp
(setq doom-font (font-spec :family "Menlo" :size 14))
#+END_SRC
** Transparency
#+BEGIN_SRC emacs-lisp
;transparent adjustment
(set-frame-parameter (selected-frame)'alpha '(94 . 94))
(add-to-list 'default-frame-alist'(alpha . (94 . 94)))
#+END_SRC
** Theme:
#+BEGIN_SRC emacs-lisp
(setq doom-theme 'doom-vibrant)
#+END_SRC
** Centaur-tabs
#+BEGIN_SRC emacs-lisp
(after! centaur-tabs
    (setq centaur-tabs-set-modified-marker t
        centaur-tabs-modified-marker "M"
        centaur-tabs-cycle-scope 'tabs
        centaur-tabs-set-close-button nil)
    (centaur-tabs-group-by-projectile-project)
    (map! :n "g t" #'centaur-tabs-forward
          :n "g T" #'centaur-tabs-backward)
    (add-hook! dired-mode #'centaur-tabs-local-mode)
)
#+END_SRC
** Winum
#+BEGIN_SRC emacs-lisp
(after! winum
  ;; (defun winum-assign-0-to-treemacs ()
  ;;   (when (string-match-p (buffer-name) "*Treemacs*") 10))

  ;; (add-to-list 'winum-assign-functions #'winum-assign-0-to-treemacs)

    (map! (:when (featurep! :ui window-select)
            :leader
            :n "0" #'treemacs-select-windows
            :n "1" #'winum-select-window-1
            :n "2" #'winum-select-window-2
            :n "3" #'winum-select-window-3
        )))
#+END_SRC
** Pretty code
#+BEGIN_SRC emacs-lisp
(setq +pretty-code-enabled-modes '(org-mode))
#+END_SRC
** TODO Golden ratio
#+BEGIN_SRC emacs-lisp
;; add to ~/.doom.d/config.el
;; (use-package! golden-ratio
;;   :after-call pre-command-hook
;;   :config
;;   (golden-ratio-mode +1)
;;   ;; Using this hook for resizing windows is less precise than
;;   ;; `doom-switch-window-hook'.
;;   (remove-hook 'window-configuration-change-hook #'golden-ratio)
;;   (add-hook 'doom-switch-window-hook #'golden-ratio) )
#+END_SRC
** TODO Ivy posframe
#+BEGIN_SRC emacs-lisp
;; (after! ivy-posframe
;;     (setq ivy-posframe-display-functions-alist
;;             '((swiper          . nil)
;;             (complete-symbol . ivy-posframe-display-at-point)
;;             (t               . ivy-posframe-display-at-frame-top-center)))
;;     (setq ivy-posframe-min-width 110)
;;     (setq ivy-posframe-width 110)
;; (setq ivy-posframe-parameters '((alpha . 85)))
;;     (setq ivy-posframe-height-alist '((t . 20))))
;; (ivy-posframe-mode)
#+END_SRC
* Magit
#+BEGIN_SRC emacs-lisp
(setq magit-repository-directories '(("~/git" . 2))
      magit-save-repository-buffers nil
      ;; Don't restore the wconf after quitting magit
      magit-inhibit-save-previous-winconf t)
#+END_SRC

* Org
** Directories:
#+BEGIN_SRC emacs-lisp
(setq org-directory "~/git/org-notes/"
      org-image-actual-width nil
      +org-export-directory "~/git/org-notes/export/"
      org-archive-location "~/git/org-notes/inbox.org_archive"
      org-default-notes-file "~/git/org-notes/inbox.org"
      org-id-locations-file "~/git/org-notes/.orgids"
      )
#+END_SRC

** Export
Load ~ox-ravel~:
#+BEGIN_SRC emacs-lisp
(load! "modules/ox-ravel")
#+END_SRC
This allows to export from ~.org~ to ~.Rmd~
** Capture
#+BEGIN_SRC emacs-lisp
(after! org

  (setq org-capture-templates
                  '(("d" "Diary")
                    ("u" "URL")))

  (add-to-list 'org-capture-templates
             '("dn" "New Diary Entry" entry(file+olp+datetree"~/git/org-notes/personal/diary.org" "Daily Logs")
"* %^{thought for the day}
:PROPERTIES:
:CATEGORY: %^{category}
:SUBJECT:  %^{subject}
:MOOD:     %^{mood}
:END:
:RESOURCES:
:END:

\*What was one good thing you learned today?*:
- %^{whatilearnedtoday}

\*List one thing you could have done better*:
- %^{onethingdobetter}

\*Describe in your own words how your day was*:
- %?"))

  (add-to-list 'org-capture-templates
      '("un" "New URL Entry" entry(file+function "~/git/org-notes/personal/dailies.org" org-reverse-datetree-goto-date-in-file)
            "* [[%^{URL}][%^{Description}]] %^g %?")))
#+END_SRC

** Prettify
#+BEGIN_SRC emacs-lisp
(setq org-bullets-bullet-list '("✖" "✚")
      org-ellipsis "▼")
#+END_SRC
** Popups
#+BEGIN_SRC emacs-lisp
(after! org (set-popup-rule! "^Capture.*\\.org$" :side 'right :size .40 :select t :vslot 2 :ttl 3))
(after! org (set-popup-rule! "*org agenda*" :side 'right :size .40 :select t :vslot 2 :ttl 3))
#+END_SRC
** org-babel
*** Key bindings:
#+BEGIN_SRC emacs-lisp
(map! :after org
;; (:when (featurep! +jupyter)
    :map evil-org-mode-map
    :n "gR" #'jupyter-org-execute-subtree
    :localleader
    :desc "Hydra" :n "," #'jupyter-org-hydra/body
    :desc "Inspect at point" :n "?" #'jupyter-inspect-at-point
    :desc "Execute and step" :n "RET" #'jupyter-org-execute-and-next-block
    :desc "Delete code block" :n "x" #'jupyter-org-kill-block-and-results
    :desc "New code block above" :n "+" #'jupyter-org-insert-src-block
    :desc "New code block below" :n "=" (λ! () (interactive) (jupyter-org-insert-src-block t nil))
    :desc "Merge code blocks" :n "m" #'jupyter-org-merge-blocks
    :desc "Split code block" :n "-" #'jupyter-org-split-src-block
    )
#+END_SRC
*** TODO Default header arguments for ~jupyter-python~:
#+BEGIN_SRC emacs-lisp
;; (after! org
;;   (setq org-babel-default-header-args:jupyter-python '((:async . "yes")
;;                                                         (:session . "py")
;;                                                         (:pandoc t)
;;                                                         (:kernel . "python3"))))
#+END_SRC

*** TODO Company backend
#+BEGIN_SRC emacs-lisp
;; (after! org
;;   (set-company-backend! 'org-mode
;;     '(company-capf)))

;; (defun add-pcomplete-to-capf ()
;;   (add-hook 'completion-at-point-functions 'pcomplete-completions-at-point nil t))

;; (add-hook 'org-mode-hook #'add-pcomplete-to-capf)

#+END_SRC
** ox-ipynb
#+BEGIN_SRC emacs-lisp
(require 'ox-ipynb)
#+END_SRC
* Python
** iPython REPL
*** virtualenv executable
#+BEGIN_SRC emacs-lisp
(defadvice! +python-poetry-open-repl-a (orig-fn &rest args)
  "Use the Python binary from the current virtual environment."
  :around #'+python/open-repl
  (if (getenv "VIRTUAL_ENV")
      (let ((python-shell-interpreter (executable-find "ipython")))
        (apply orig-fn args))
    (apply orig-fn args)))
#+END_SRC
*** Ignore popup rule
#+BEGIN_SRC emacs-lisp
(set-popup-rule! "^\\*Python*" :ignore t)
#+END_SRC
*** Set REPL handler
On a scratch buffer, first run ~jupyter-associate-buffer~.
Then, hitting ~SPC o r~ allows use to hit the REPL buffer with the lines/regions
of code we send with ~g r~.
#+BEGIN_SRC emacs-lisp
(after! python
  (set-repl-handler! 'python-mode #'+python/open-ipython-repl :persist t))
#+END_SRC
*** Keybindings
#+BEGIN_SRC emacs-lisp
(map!
 :map python-mode-map
 :localleader
 :desc "Eval region" :v "r" #'python-shell-send-region
)
#+END_SRC
*** Silence warnings when opening REPL
#+BEGIN_SRC emacs-lisp
(setq python-shell-prompt-detect-failure-warning nil)
#+END_SRC
* R
** Disable popup rule
#+BEGIN_SRC emacs-lisp
(set-popup-rule! "^\\*R:" :ignore t)
#+END_SRC
* Shell
** Async Shell command
#+BEGIN_SRC emacs-lisp
(defun shell-command-print-separator ()
  (overlay-put (make-overlay (point-max) (point-max))
               'before-string
               (propertize "!" 'display
                           (list 'left-fringe
                                 'right-triangle))))

(advice-add 'shell-command--save-pos-or-erase :after 'shell-command-print-separator)
#+END_SRC
** Eshell aliases
#+BEGIN_SRC emacs-lisp
(after! eshell
  (set-eshell-alias!
   "fd" "+eshell/fd $1"
   "fo" "find-file-other-window $1"))
#+END_SRC
